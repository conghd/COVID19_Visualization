<html>

<head>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif
        }

        h1 {
            background-color: #2a5599;
            color: white;
            padding: 5px;
        }

        svg {
            border: black solid 1px;
            width: 100%;
        }

        .mainView {
            display: flex;
            flex-direction: row;
        }
        .mainView div {
            flex: 1;
        }
    </style>
    <script src="d3.js"></script> 
</head>

<body>
    <h1>Airlines Routes</h1>
    <div class="mainView">
        <div>
            <h2>Airlines</h2>
            <svg id="AirlinesChart"></svg>
        </div>
        <div>
            <h2>Airports</h2>
            <svg id="Map"></svg>
        </div>
    </div>
</body>
<script>
    let store = {}

    function loadData() {
        let promise = d3.csv("routes.csv") //TODO 1: Add the code to load the CSV file named "routes.csv" | 1 Line

        return promise.then(routes => {
            store.routes = routes//TODO 2: Save the routes into our store variable;
            return store;
        })
    }

    function groupByAirline(data) {
        //Iterate over each route, producing a dictionary where the keys is are the ailines ids and the values are the information of the airline.
        let result = data.reduce((result, d) => {
            let currentData = result[d.AirlineID] || {
                "AirlineID": d.AirlineID,
                "AirlineName": d.AirlineName,
                "Count": 0
            }
            
            currentData.Count += 1//TODO: Increment the count (number of routes) of ariline.
            
            result[d.AirlineID] = currentData //TODO: Save the updated information in the dictionary using the airline id as key.

            return result;
        }, {})

        //We use this to convert the dictionary produced by the code above, into a list, that will make it easier to create the visualization. 
        result = Object.keys(result).map(key => result[key])
        result = result.sort((a, b) => {
            return d3.descending(a.Count, b.Count)
        })
        //TODO: Sort the data in descending order of count.

        return result
    }

    function drawAirlinesChart(airlines) {
        let config = getAirlinesChartConfig();
        let scales = getAirlinesChartScales(airlines, config);
        drawBarsAirlinesChart(airlines, scales, config);
        drawAxesAirlinesChart(airlines, scales, config);
    }

    function drawBarsAirlinesChart(airlines, scales, config) {
        let { margin, container } = config;
        let { xScale, yScale } = scales;
        let body = container.append("g")
                .style("transform", `translate(${margin.left}px,${margin.top}px)`)
        let bars = body.selectAll(".bar")
                        .data(airlines)
        bars.enter().append("rect")
            .attr("height", yScale.bandwidth())
            .attr("y", (d) => yScale(d.AirlineName))
            .attr("width", d => xScale(d.Count))
            .attr("fill", "#2a5599")

    }

    function showData() {
      //Get the routes from our store variable
      let routes = store.routes
      // Compute the number of routes per airline.
      let airlines = groupByAirline(store.routes);
      console.log(airlines)

      // Draw airlines barchart
      drawAirlinesChart(airlines);
    }

    function getAirlinesChartConfig() {
        let width = 350;
        let height = 400;
        let margin = {
            top: 10,
            bottom: 50,
            left: 130,
            right: 10
        }
        let bodyHeight = height - margin.top - margin.bottom;
        let bodyWidth = width - margin.left - margin.right;

        let container = d3.select("#AirlinesChart")
        container
            .attr("width", width)
            .attr("height", height)

        return { width, height, margin, bodyHeight, bodyWidth, container }
    }

    function getAirlinesChartScales(airlines, config) {
        let { bodyWidth, bodyHeight } = config;
        let maximumCount = d3.max(airlines, airline => airline.Count)

        let xScale =
            d3.scaleLinear()
              .range([0, bodyWidth])
              .domain([0, maximumCount])

        let yScale =
            d3.scaleBand()
              .range([0, bodyHeight])
              .domain(airlines.map(a => a.AirlineName))
              .padding(0.2)

        return { xScale, yScale }

    }

    function drawAxesAirlinesChart(airlines, scales, config) {
        let { xScale, yScale } = scales;
        let { container, margin, height } = config;
        let axisX = d3.axisBottom(xScale)
            .ticks(5)
        container.append("g")
            .style("transform",
                `translate(${margin.left}px,${height - margin.bottom}px)`
            )
            .call(axisX)

        let yAxis = d3.axisLeft(yScale)
        container.append("g")
            .style("transform",
                `translate(${margin.left}px, ${margin.top}px)`
            )
            .call(yAxis)
    }
    loadData().then(showData);
</script>
</html>